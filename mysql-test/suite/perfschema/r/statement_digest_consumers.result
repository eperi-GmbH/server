####################################
# SETUP
####################################
CREATE DATABASE statements_digest;
USE statements_digest;
CREATE TABLE t1(a int);
CREATE TABLE t2(a int);
CREATE TABLE t3(a int, b int);
CREATE TABLE t4(a int, b int);
CREATE TABLE t5(a int, b int, c int);
CREATE TABLE t6(a int, b int, c int, d int);
CREATE TABLE t11 (c CHAR(4));
CREATE TABLE t12 (c CHAR(4));
SELECT * FROM performance_schema.setup_consumers;
NAME	ENABLED
events_stages_current	YES
events_stages_history	YES
events_stages_history_long	YES
events_statements_current	NO
events_statements_history	YES
events_statements_history_long	YES
events_waits_current	YES
events_waits_history	YES
events_waits_history_long	YES
global_instrumentation	YES
thread_instrumentation	YES
statements_digest	YES
TRUNCATE TABLE performance_schema.events_statements_summary_by_digest;
####################################
# EXECUTION
####################################
SELECT 1 FROM t1;
1
SELECT 1 FROM `t1`;
1
SELECT 1,2 FROM t1;
1	2
SELECT 1, 2, 3, 4 FROM t1;
1	2	3	4
SELECT 1 FROM t2;
1
SELECT 1,2 FROM t2;
1	2
SELECT 1, 2, 3, 4 FROM t2;
1	2	3	4
INSERT INTO t1 VALUES (1);
INSERT INTO t2 VALUES (1);
INSERT INTO t3 VALUES (1, 2);
INSERT INTO t4 VALUES (1, 2);
INSERT INTO t5 VALUES (1, 2, 3);
INSERT INTO t1 VALUES (1), (2), (3);
INSERT INTO t1 VALUES (1), (2), (3), (4);
INSERT INTO t3 VALUES (1, 2), (3, 4), (5, 6);
INSERT INTO t5 VALUES (1, 2, 3), (4, 5, 6), (7, 8, 9);
INSERT INTO t1 VALUES (NULL);
INSERT INTO t3 VALUES (NULL,NULL);
INSERT INTO t3 VALUES (1,NULL);
INSERT INTO t3 VALUES (NULL,1);
INSERT INTO t6 VALUES (NULL, NULL, NULL, NULL);
INSERT INTO t6 VALUES (1, NULL, NULL, NULL);
INSERT INTO t6 VALUES (NULL, 2, NULL, NULL);
INSERT INTO t6 VALUES (1, 2, 3, NULL);
INSERT INTO t6 VALUES (1, 2, NULL, 4);
SELECT                                          1           +        1;
1           +        1
2
SELECT 1;
1
1
SELECT 1 /* This is an inline comment */ + 1;
1 /* This is an inline comment */ + 1
2
SELECT 1+
/*
this is a
multiple-line comment
*/
1;
1+
/*
this is a
multiple-line comment
*/
1
2
CREATE SCHEMA statements_digest_temp;
DROP SCHEMA statements_digest_temp;
CREATE DATABASE statements_digest_temp;
DROP DATABASE statements_digest_temp;
SELECT 1 FROM no_such_table;
ERROR 42S02: Table 'statements_digest.no_such_table' doesn't exist
CREATE TABLE dup_table (c char(4));
CREATE TABLE dup_table (c char(4));
ERROR 42S01: Table 'dup_table' already exists
DROP TABLE dup_table;
INSERT INTO t11 VALUES("MySQL");
Warnings:
Warning	1265	Data truncated for column 'c' at row 1
PREPARE stmt FROM "SELECT * FROM t12";
EXECUTE stmt;
c
EXECUTE stmt;
c
DEALLOCATE PREPARE stmt;
CREATE PROCEDURE p1() BEGIN SELECT * FROM t12; END//
CALL p1();
c
CALL p1();
c
DROP PROCEDURE p1;
CREATE FUNCTION `func`(a INT, b INT) RETURNS int(11) RETURN a+b //
select func(3,4);
func(3,4)
7
select func(13,42);
func(13,42)
55
DROP FUNCTION func;
CREATE TRIGGER trg BEFORE INSERT ON t12 FOR EACH ROW SET @a:=1;
INSERT INTO t12 VALUES ("abc");
INSERT INTO t12 VALUES ("def");
DROP TRIGGER trg;
####################################
# QUERYING PS STATEMENT DIGEST
####################################
SELECT schema_name, digest, digest_text, count_star FROM performance_schema.events_statements_summary_by_digest;
schema_name	digest	digest_text	count_star
statements_digest	54be536bf8c0547bb1deba404fe8d4d9	TRUNCATE TABLE performance_schema . events_statements_summary_by_digest 	1
statements_digest	5cec822a2b4afb0361fcafbd35812d3f	SELECT ? FROM t1 	1
statements_digest	9cc532095a17d9c7e019997198b034bd	SELECT ? FROM `t1` 	1
statements_digest	ca0acd401eaac519b14133957a035500	SELECT ?, ... FROM t1 	2
statements_digest	0016daff53145841d2c1b94dd45d59f2	SELECT ? FROM t2 	1
statements_digest	a2190aad3dad05e7a47ededa3dc5fbba	SELECT ?, ... FROM t2 	2
statements_digest	be3901910569c5698c97b6eb861a2417	INSERT INTO t1 VALUES (?) 	1
statements_digest	96be514897ecce5889ce3bccfdaee2bc	INSERT INTO t2 VALUES (?) 	1
statements_digest	c9b90c24e4e4a2e6c6d3b00124fb4e24	INSERT INTO t3 VALUES (...) 	4
statements_digest	ace1b379cc20a6c189035362dc8960eb	INSERT INTO t4 VALUES (...) 	1
statements_digest	fee63a8398ac269df45ab5578053d8cf	INSERT INTO t5 VALUES (...) 	1
statements_digest	db4d5d49a7448126279ac33dcd27abb0	INSERT INTO t1 VALUES (?) /* , ... */ 	2
statements_digest	ddd193e1da292c9cf1d1d11e04df34d7	INSERT INTO t3 VALUES (...) /* , ... */ 	1
statements_digest	a807cdb22b8f6a0b663917f97fe12fab	INSERT INTO t5 VALUES (...) /* , ... */ 	1
statements_digest	7b55a76a009c39141f5c8f2ab01b4786	INSERT INTO t1 VALUES ( NULL ) 	1
statements_digest	6bebbe9ad352b632cb52990696b5eb06	INSERT INTO t6 VALUES (...) 	5
statements_digest	22a91f68f552af38d2241be9c075a76a	SELECT ? + ? 	3
statements_digest	9ea9ecb4e86ec71510f7f525bbc33104	SELECT ? 	1
statements_digest	3b085ab0d2063dfca1a39212e3ea1831	CREATE SCHEMA statements_digest_temp 	2
statements_digest	09f9fabef2feb9a54ba01455e5ae83b9	DROP SCHEMA statements_digest_temp 	2
statements_digest	cb5deeb5b4fd13b4a35cb68fb152357b	SELECT ? FROM no_such_table 	1
statements_digest	e31381c2456360fb73bf1700fbe94243	CREATE TABLE dup_table ( c CHARACTER (?) ) 	2
statements_digest	4a5bcfc4f64e714131a8f3314a224367	DROP TABLE dup_table 	1
statements_digest	a11239a8dcde8b6c35ba7176c9799868	INSERT INTO t11 VALUES (?) 	1
statements_digest	46a1658b73f99ee7160fae631fb93a09	SHOW WARNINGS 	1
statements_digest	8f991811edef3847b3899adf74f25cd2	PREPARE stmt FROM ? 	1
statements_digest	3ab1e87eabd9688edf919754cce6348b	EXECUTE stmt 	2
statements_digest	f89bf06a01e83eece5a6b14e73f33b6e	DEALLOCATE PREPARE stmt 	1
statements_digest	036728a7f9500af03c75a7b2f52598d6	CREATE PROCEDURE p1 ( ) BEGIN SELECT * FROM t12 ; END 	1
statements_digest	e58546d78a966f2323cd92a256346c25	CALL p1 ( ) 	2
statements_digest	7ae8f5e01f2be4e289a49482109ebe15	DROP PROCEDURE p1 	1
statements_digest	033a4fd9798287673b42eb44d2f4217f	CREATE FUNCTION `func` ( a INTEGER , b INTEGER ) RETURNS INTEGER (?) RETURN a + b 	1
statements_digest	50918248239b985150c045c74d4bc0a7	SELECT func (...) 	2
statements_digest	0b5a5297689c5036def6af8e8a8ce113	DROP FUNCTION func 	1
statements_digest	f0b5ccca009965ffa9e2e8d9ff27e7a8	CREATE TRIGGER trg BEFORE INSERT ON t12 FOR EACH ROW SET @ ? := ? 	1
statements_digest	0f202992bc6f282752cc1dd8f4799efb	INSERT INTO t12 VALUES (?) 	2
statements_digest	6c9ad477f1626f7bccd72257f487ecfb	DROP TRIGGER trg 	1
SELECT digest, digest_text FROM performance_schema.events_statements_current;
digest	digest_text
####################################
# CLEANUP
####################################
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;
DROP TABLE IF EXISTS t3;
DROP TABLE IF EXISTS t4;
DROP TABLE IF EXISTS t5;
DROP TABLE IF EXISTS t6;
DROP TABLE IF EXISTS t11;
DROP TABLE IF EXISTS t12;
DROP DATABASE IF EXISTS statements_digest;
